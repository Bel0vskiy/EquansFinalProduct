# GNN Model Documentation

This document explains the purpose and usage of the key Python scripts for the Graph Neural Network (GNN) model. The typical workflow is:

1.  **`preprocess.py`**: Convert raw data into graph datasets.
2.  **`Model/train.py`**: Train the GNN model on the graph datasets.
3.  **`Model/evaluate.py`**: Evaluate the performance of the trained model on a specific room.

---

## 1. `preprocess.py`

### Purpose

This script is the first step in the data pipeline. It takes normalized architectural data for different building units (rooms), identifies specific components to be used as prediction targets (e.g., a single wall socket), and converts each unit into a set of graph files (`.pt`).

Each graph file represents the entire room but is specialized for a single target component instance. In the graph, the position of this target component is masked (zeroed out) to create a training example where the model must learn to predict its location based on the surrounding context.

### How to Run

The script is run from the `GNN/` directory. You need to provide paths to the data, an index file specifying which units to process, and an output directory for the generated graphs.

**Command:**
```bash
python preprocess.py 
```

**Key Arguments:**

All following arguments are already set as default
*   `--data_dir`: Path to the root directory containing the normalized data (e.g., `Data/DataNormalized`).
*   `--index_json`: Path to a JSON file that lists the specific building units to be processed (e.g., `Data/DataTraining/wcd_enkelvoudig_index.json`).
*   `--output_dir`: The directory where the final `.pt` graph files will be saved (e.g., `Model/graphs`).
*   `--target_component`: The name of the component type that the model should learn to place. Defaults to "wcd enkelvoudig".



## 2. `Model/train.py`

### Purpose

This script trains the GNN using the graph files generated by `preprocess.py`. It learns to predict the correct surface and coordinates for the masked component in each graph. The script supports two training modes:

1.  **Standard Train/Validation**: Uses a fixed split of the data for training and validation. It saves the best performing model weights to `GNN/Model/checkpoints/best.pth`.
2.  **K-Fold Cross-Validation**: Performs a more robust evaluation by splitting the data into multiple folds and averaging the performance across them.

### GPU Support

The training script automatically utilizes GPU acceleration if available. It supports:
*   **CUDA**: For NVIDIA GPUs on Windows/Linux.
*   **MPS**: For Apple Silicon (M chips) on macOS.
*   **CPU**: Fallback if no GPU is detected.

To ensure GPU usage, make sure your PyTorch installation matches your hardware (e.g., `pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118` for CUDA).

### How to Run

The script is run from the `GNN/` directory. You must specify which training mode to use by providing either a `split_json` or a `kfold_json` file.

**Command:**
```bash
# For standard training
python Model/train.py --split_json <path_to_split_file.json>

# For k-fold cross-validation
python Model/train.py --kfold_json <path_to_kfold_file.json>
```

**Key Arguments:**

*   `--graphs_dir`: Path to the directory containing the preprocessed graph files from `preprocess.py`. Defaults to `Model/graphs`.
*   `--split_json`: (Required for standard training) Path to a JSON file defining the training and validation sets.
*   `--kfold_json`: (Required for k-fold training) Path to a JSON file defining the data folds.
*   `--resume`: Optional flag to resume training from the last saved checkpoint.

**Example (Standard Training):**
```bash
# Assuming you are in the GNN/ directory
python Model/train.py --split_json Data/DataTraining/wcd_enkelvoudig_split.json

# For kfold:
python Model/train.py --kfolds_json Data/DataTraining/wcd_enkelvoudig_kfolds.json
```

---

## 3. `Model/evaluate.py`

### Purpose

This script is used to evaluate a trained model on a single, unprocessed architectural unit. It loads the best saved model (`GNN/Model/checkpoints/best.pth`), builds a graph for the specified unit in real-time, and runs inference to predict the placement of the target component.

It provides a detailed breakdown of the results, including the model's confidence scores for different surfaces and the final predicted position vs. the ground truth, including the error distance in millimeters.

### How to Run

The script is run from the `GNN/` directory. You must provide the path to the raw, normalized unit directory you want to evaluate.

**Command:**
```bash
python Model/evaluate.py --unit_dir <path_to_unit_directory>
```

**Key Arguments:**

*   `--unit_dir`: (Required) Path to the specific, normalized unit directory you want to evaluate. For example, `Data/DataNormalized/gebouwE/unit_0001`.

**Example:**
```bash
# Assuming you are in the GNN/ directory
python Model/evaluate.py --unit_dir Data/DataNormalized/gebouwE/unit_0001
```
Make sure that you are using a unit that has at least one target component.

---

## 4. `UI/main_UI.py` (User Interface)

### Purpose

This script launches the graphical user interface (GUI) for visually interacting with the data and the GNN model. It allows you to:
- Browse and load specific buildings and units.
- Visualize the 3D room geometry and objects.
- Run the GNN model to predict component positions directly in the viewer.
- Compare the predicted position with the ground truth using visual markers.

### How to Run

1.  Open your terminal in the `GNN/` directory.
2.  Run the following command:
    ```bash
    python UI/main_UI.py
    ```

### User Guide

#### 1. Loading Data
*   **Select Building Folder**: On the left panel, click "Select Building Folder...". Navigate to and select the root directory of your building data (e.g., `EquansFinalProduct/EquansFinalProduct`). This directory should contain subfolders named `unit_XXXX`.
*   **Select Unit**: Once the building folder is set, the "Select Unit" dropdown will populate. Choose a unit from the list.
*   **Load Unit**: Click "Load Selected Unit" to visualize the room. You can also use "Load All Units" to see multiple rooms or "Clear Loaded Units" to reset the scene.

#### 2. 3D Visualization Controls
The main window displays the 3D interactive scene.
*   **Rotate**: Left-click and drag.
*   **Pan**: Shift + Left-click and drag (or Middle-click and drag).
*   **Zoom**: Mouse wheel scroll (or Right-click and drag).
*   **Reset View**: Use the "Reset View" button in the "Scene Controls" panel or the View menu to reset the camera.

#### 3. Data Visibility & Inspection
*   **Visibility Panel**: Toggle the checkboxes to show/hide specific units or object categories (e.g., "ET" for electrical).
*   **Object Details**: Click on any object in the "Object Details" list to highlight it in yellow in the 3D view and see its properties (dimensions, coordinates).

#### 4. GNN Prediction (New Feature)
Use the **"GNN Prediction (wcd enkelvoudig)"** panel to run the model:
1.  **Select Target Object**: Choose a specific target instance (e.g., a socket) from the dropdown list.
2.  **Predict Position**: Click the button to run the GNN inference for that target.
    *   **Green Sphere**: Indicates the **True Position** (Ground Truth).
    *   **Orange Sphere**: Indicates the **Predicted Position** by the GNN.
    *   **Labels**: Text labels ("True Position", "Predicted Position") identify the markers.
    *   **Results Text**: Displays the Error (in mm) and detailed coordinates in the text box.
3.  **Clear Prediction**: Click this button to remove the prediction markers and reset the selection, allowing you to choose a different target or clear the view.
