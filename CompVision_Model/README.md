# Computer Vision Module for Socket Detection

This directory contains the Computer Vision (CV) pipeline used to detect electrical sockets from 3D BIM geometry. The system "unfolds" 3D walls into 2D images, trains a U-Net segmentation model to identify sockets, and projects predictions back into 3D space for verification.

## üìÇ Project Structure

### Core Pipeline
- **`build_dataset.py`**: The main data processing script. It iterates through the raw 3D data, extracts walls using the unfolding engine, generates ground truth masks from JSON metadata, and saves the processed dataset to `CV_Dataset/`.
- **`train_vision.py`**: Trains the U-Net model using the generated dataset. It handles data loading, the training loop, validation, and saves model checkpoints to `results/`.
- **`vision_model.py`**: Defines the neural network architecture. It uses a U-Net with a pre-trained ResNet34 encoder via the `segmentation_models_pytorch` library.
- **`wall_unfolding.py`**: The geometric core of the project. It handles:
  - Loading 3D meshes (OBJ files).
  - Clustering faces to identify individual walls (using DBSCAN).
  - Generating 2D image representations (U and V coordinate channels).
  - Mapping 2D pixels back to 3D coordinates.

### Visualization & Evaluation
- **`visualize_unit_with_predictions.py`**: The end-to-end inference script. It loads a trained model, processes a specific building unit, predicts socket locations, and visualizes the results in an interactive 3D scene (comparing Ground Truth vs. Predictions).
- **`check_2D_results.py`**: Visualizes random samples from the dataset alongside the model's 2D predictions to quickly assess training progress.
- **`inspect_dataset.py`**: A utility to inspect the generated `CV_Dataset`. It calculates global stats (e.g., percentage of walls with sockets) and visualizes specific units to ensure data integrity.
- **`unfolding_visual.py`**: A debugging tool to visualize the raw U/V channels and masks generated by the unfolding engine without running the full dataset build.

---

## üöÄ Setup & Installation

Ensure you have the required dependencies installed. Add the following to your `requirements.txt` if not already present:

```text
torch
numpy
matplotlib
pyvista
opencv-python
segmentation-models-pytorch
scikit-learn
tqdm
scipy
```

## ‚öôÔ∏è Usage Workflow

### 1. Build the Dataset
Before training, you must generate the 2D dataset from your 3D source files.

```bash
python build_dataset.py
```

- **Input**: Scans for data in `../GNN/Data/DataOriginal` (configurable in script).
- **Output**: Creates a `CV_Dataset/` folder containing `images/` (inputs), `masks/` (ground truth), and `meta/` (mapping data).

### 2. Train the Model
Run the training script to train the U-Net.

```bash
python train_vision.py
```

- **Configuration**: You can adjust `BATCH_SIZE`, `LR` (Learning Rate), and `EPOCHS` at the top of the script.
- **Output**: Saves the best model weights to `results/best.pth` and debug snapshots to `results/debug_current.png`.

### 3. Visual Inspection (2D)
To quickly check how well the model is performing on individual walls:

```bash
python check_2D_results.py
```

### 4. Full 3D Inference & Visualization
To see the final product‚Äîpredictions projected back onto the 3D building model:

```bash
python visualize_unit_with_predictions.py
```

- **Target**: Change the `TARGET_UNIT` variable (default: `"rotterdam_0002"`) to inspect different units.
- **Controls**: The script opens a PyVista window. You can rotate, zoom, and pan to inspect the placement of sockets (Red/Yellow spheres) vs. Ground Truth (Green spheres).

## üõ† Configuration Notes
- **Data Paths**: Most scripts assume the raw data is located at `../main/Data/DataOriginal`. If your folder structure is different, update the `DATA_ROOT` variable in `build_dataset.py` and `visualize_unit_with_predictions.py`.
- **Image Size**: The default resolution is `256x256`. This can be changed via `IMG_SIZE` in `build_dataset.py`, but ensure you retrain the model if you change this.

---

**Sources:**
- `build_dataset.py`
- `train_vision.py`
- `vision_model.py`
- `wall_unfolding.py`
- `visualize_unit_with_predictions.py`
- `check_2D_results.py`
- `inspect_dataset.py`
- `unfolding_visual.py`